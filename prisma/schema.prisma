generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Таблица пользователей (замена auth.users)
model User {
  id                String   @id @default(cuid())
  email             String   @unique
  emailVerified     DateTime?
  name              String?
  role              UserRole @default(STUDENT)
  image             String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Связи
  accounts          Account[]
  sessions          Session[]
  teacherRelations  TeacherStudentRelation[] @relation("TeacherRelations")
  studentRelations  TeacherStudentRelation[] @relation("StudentRelations")
  createdInvites    InviteLink[] @relation("InviteCreator")
  lessons           Lesson[]
  inviteUses        InviteUse[]
  files             File[]
  boards            Board[]        @relation("BoardCreator")
  boardElements     BoardElement[] @relation("ElementCreator")
  sentMessages      ChatMessage[]  @relation("MessageSender")
  messageReads      ChatMessageRead[] @relation("MessageReader")

  @@map("users")
}

enum UserRole {
  STUDENT
  TEACHER
}

// NextAuth таблицы
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// Существующие таблицы проекта
model TeacherStudentRelation {
  id              String         @id @default(cuid())
  teacherId       String         @map("teacher_user_id")
  studentId       String         @map("student_user_id")
  status          RelationStatus @default(PENDING)
  teacherName     String?        @map("teacher_custom_name")
  studentName     String?        @map("student_custom_name")
  teacherNotes    String?        @map("teacher_notes")
  studentNotes    String?        @map("student_notes")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  deletedAt       DateTime?      @map("deleted_at")

  teacher    User        @relation("TeacherRelations", fields: [teacherId], references: [id])
  student    User        @relation("StudentRelations", fields: [studentId], references: [id])
  lessons    Lesson[]    @relation("LessonRelation")
  files      File[]
  fileShares FileShare[]
  boards     Board[]     @relation("BoardRelation")
  messages   ChatMessage[]

  @@unique([teacherId, studentId])
  @@map("teacher_student_relations")
}

enum RelationStatus {
  PENDING
  ACTIVE
  REJECTED
  BLOCKED
}

model Lesson {
  id          String      @id @default(cuid())
  title       String
  description String?
  startTime   DateTime    @map("start_time")
  endTime     DateTime    @map("end_time")
  userId      String      @map("user_id")
  relationId  String?     @map("relation_id")
  boardId     String?     @map("board_id")
  isRecurring Boolean     @default(false) @map("is_recurring")
  recurrence  Json?       @map("recurrence_pattern")
  labelColor  String?     @map("label_color")
  status      String      @default("scheduled") @map("status")
  previousStartTime DateTime? @map("previous_start_time")
  previousEndTime   DateTime? @map("previous_end_time")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id])
  relation TeacherStudentRelation? @relation("LessonRelation", fields: [relationId], references: [id])
  board Board? @relation("LessonBoard", fields: [boardId], references: [id], onDelete: SetNull)

  @@index([boardId])
  @@map("lessons")
}

model InviteLink {
  id          String      @id @default(cuid())
  code        String      @unique
  type        InviteType
  message     String?
  expiresAt   DateTime    @map("expires_at")
  createdById String      @map("created_by")
  createdAt   DateTime    @default(now()) @map("created_at")
  isActive    Boolean     @default(true) @map("is_active")

  createdBy User        @relation("InviteCreator", fields: [createdById], references: [id])
  uses      InviteUse[]

  @@map("invite_links")
}

enum InviteType {
  STUDENT_TO_TEACHER
  TEACHER_TO_STUDENT
}

model InviteUse {
  id         String   @id @default(cuid())
  inviteId   String   @map("invite_link_id")
  userId     String   @map("user_id")
  usedAt     DateTime @default(now()) @map("used_at")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")

  invite InviteLink @relation(fields: [inviteId], references: [id])
  user   User       @relation(fields: [userId], references: [id])

  @@map("invite_uses")
}

model File {
  id           String   @id @default(cuid())
  name         String
  originalName String   @map("original_name")
  size         Int
  mimeType     String   @map("mime_type")
  fileType     FileType @map("file_type")
  path         String
  url          String?
  userId       String   @map("user_id")
  relationId   String?  @map("relation_id")
  isPublic     Boolean  @default(false) @map("is_public")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  user     User                       @relation(fields: [userId], references: [id], onDelete: Cascade)
  relation TeacherStudentRelation?    @relation(fields: [relationId], references: [id], onDelete: SetNull)
  shares   FileShare[]

  @@map("files")
}

// Модель для шаринга файлов между учителем и учеником
model FileShare {
  id         String   @id @default(cuid())
  fileId     String   @map("file_id")
  relationId String   @map("relation_id")
  createdAt  DateTime @default(now()) @map("created_at")

  file     File                   @relation(fields: [fileId], references: [id], onDelete: Cascade)
  relation TeacherStudentRelation @relation(fields: [relationId], references: [id], onDelete: Cascade)

  @@unique([fileId, relationId])
  @@map("file_shares")
}

enum FileType {
  DOCUMENT
  IMAGE
  VIDEO
  AUDIO
  ARCHIVE
  OTHER
}

// ============================================================================
// Доска для проведения уроков
// ============================================================================

model Board {
  id          String   @id @default(cuid())
  title       String   @default("Без названия")
  teacherId   String   @map("teacher_id")
  relationId  String?  @map("relation_id")
  settings    Json     @default("{\"background\":\"#ffffff\",\"gridEnabled\":false}")
  thumbnail   String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  teacher  User                    @relation("BoardCreator", fields: [teacherId], references: [id], onDelete: Cascade)
  relation TeacherStudentRelation? @relation("BoardRelation", fields: [relationId], references: [id], onDelete: SetNull)
  elements BoardElement[]
  lessons  Lesson[]                @relation("LessonBoard")

  @@index([teacherId])
  @@index([relationId])
  @@map("boards")
}

model BoardElement {
  id        String   @id @default(cuid())
  boardId   String   @map("board_id")
  type      String   // pen, text, rect, circle, line, image, highlight
  data      Json     // { points, position, style, content, src, ... }
  zIndex    Int      @default(0) @map("z_index")
  createdBy String   @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  board   Board @relation(fields: [boardId], references: [id], onDelete: Cascade)
  creator User  @relation("ElementCreator", fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([boardId])
  @@map("board_elements")
}

// ============================================================================
// Чат между учителем и учеником
// ============================================================================

model ChatMessage {
  id         String      @id @default(cuid())
  relationId String      @map("relation_id")
  senderId   String      @map("sender_id")
  text       String      @db.Text
  createdAt  DateTime    @default(now()) @map("created_at")
  editedAt   DateTime?   @map("edited_at")

  relation TeacherStudentRelation @relation(fields: [relationId], references: [id], onDelete: Cascade)
  sender   User                   @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  reads    ChatMessageRead[]

  @@index([relationId, createdAt])
  @@index([senderId])
  @@map("chat_messages")
}

model ChatMessageRead {
  id        String   @id @default(cuid())
  messageId String   @map("message_id")
  userId    String   @map("user_id")
  readAt    DateTime @default(now()) @map("read_at")

  message ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User        @relation("MessageReader", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([userId, readAt])
  @@map("chat_message_reads")
}
